<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conjugar â€” A1/A2</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2D5016">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F2;
    --surface: #FFFFFF;
    --border: #E8E4DF;
    --text: #1A1714;
    --text-muted: #8C8580;
    --accent: #2D5016;
    --accent-light: #EBF2E3;
    --accent2: #C85A1B;
    --irreg: #C85A1B;
    --irreg-bg: #FDF0E8;
    --a1: #2D5016;
    --a2: #1A4A6B;
    --a2-bg: #E8F2F8;
    --shadow: 0 2px 16px rgba(26,23,20,0.07);
    --radius: 16px;
    --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
  }

  [data-theme="dark"] {
    --bg: #141210;
    --surface: #1E1C1A;
    --border: #2E2B28;
    --text: #F0EDE8;
    --text-muted: #7A756F;
    --accent: #5A9E35;
    --accent-light: #1E2E14;
    --accent2: #E07840;
    --irreg: #E07840;
    --irreg-bg: #2A1C10;
    --a1: #5A9E35;
    --a2: #4A8AB0;
    --a2-bg: #0E1E2A;
    --shadow: 0 2px 16px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* NAV */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 8px;
  }
  .nav-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--accent);
    letter-spacing: -0.5px;
    flex-shrink: 0;
  }
  .nav-tabs {
    display: flex;
    gap: 2px;
    background: var(--bg);
    border-radius: 10px;
    padding: 3px;
    flex-shrink: 0;
  }
  .nav-tab {
    padding: 6px 12px;
    border-radius: 7px;
    border: none;
    background: transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
  }
  .nav-tab.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: var(--shadow);
  }
  .nav-right { display: flex; justify-content: flex-end; flex-shrink: 0; }

  /* PAGES */
  .page { display: none; flex: 1; }
  .page.active { display: flex; flex-direction: column; }

  /* ======= PRACTICE PAGE ======= */
  #page-practice {
    align-items: center;
    padding: 24px 16px;
    gap: 20px;
  }

  /* Category bar */
  .category-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 760px;
    width: 100%;
  }
  .cat-btn {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
  }
  .cat-btn:hover { border-color: var(--accent); color: var(--accent); }
  .cat-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  /* Main card */
  .card-wrap {
    max-width: 520px;
    width: 100%;
    perspective: 1000px;
  }
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    padding: 48px 40px 40px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    min-height: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    user-select: none;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(26,23,20,0.1); }
  .card:active { transform: translateY(0); }

  .card-stage-label {
    position: absolute;
    top: 16px;
    left: 20px;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.3px;
    color: var(--text-muted);
  }

  .card-sound-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    font-size: 16px;
  }
  .card-sound-btn:hover { background: var(--accent-light); border-color: var(--accent); }

  .pronoun-badge {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    font-weight: 400;
    font-style: italic;
    color: var(--text-muted);
    background: var(--bg);
    border-radius: 8px;
    padding: 5px 14px;
    letter-spacing: -0.3px;
  }

  .card-infinitive {
    font-family: 'DM Serif Display', serif;
    font-size: 42px;
    color: var(--text);
    line-height: 1.1;
    letter-spacing: -1px;
  }

  .card-meaning {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 400;
  }

  .card-level-badge {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding: 3px 9px;
    border-radius: 5px;
  }
  .level-a1 { background: var(--accent-light); color: var(--accent); }
  .level-a2 { background: var(--a2-bg); color: var(--a2); }

  /* Answer state */
  .card-answer {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .card.revealed .card-answer { display: flex; }
  .card.revealed .card-pre-reveal { display: none; }
  .card-pre-reveal { display: flex; flex-direction: column; align-items: center; gap: 12px; }

  .conjugated-form {
    font-family: 'DM Serif Display', serif;
    font-size: 52px;
    color: var(--accent);
    letter-spacing: -1.5px;
    line-height: 1.0;
  }
  .conjugated-form.irregular {
    color: var(--irreg);
  }

  .irreg-tag {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--irreg);
    background: var(--irreg-bg);
    border-radius: 5px;
    padding: 3px 8px;
  }

  .click-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    opacity: 0.7;
  }

  /* Card bottom row â€” prev/next nav buttons */
  .card-controls {
    max-width: 520px;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  .nav-arrow-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: var(--surface);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    color: var(--text-muted);
    flex-shrink: 0;
    box-shadow: var(--shadow);
  }
  .nav-arrow-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-light);
    transform: scale(1.05);
  }
  .nav-arrow-btn:active { transform: scale(0.96); }

  .progress-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .progress-bar {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    min-width: 80px;
  }
  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.4s ease;
  }
  .progress-count {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* ======= REFERENCE PAGE ======= */
  #page-reference {
    padding: 24px 16px;
    align-items: center;
  }
  .ref-container {
    max-width: 860px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  .ref-header {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .ref-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .tense-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .tense-block-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .tense-name {
    font-weight: 600;
    font-size: 15px;
  }
  .tense-level {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 5px;
    flex-shrink: 0;
  }
  .tense-block-body {
    padding: 16px;
  }
  .tense-desc {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 14px;
    line-height: 1.6;
  }

  .endings-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 14px;
  }
  @media (max-width: 600px) {
    .endings-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (max-width: 380px) {
    .endings-grid {
      grid-template-columns: 1fr;
    }
  }
  .ending-group {
    background: var(--bg);
    border-radius: 10px;
    padding: 12px;
    min-width: 0;
  }
  .ending-group-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  .ending-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 0;
    font-size: 12px;
    gap: 4px;
  }
  .ending-pron { color: var(--text-muted); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .ending-end {
    font-weight: 600;
    font-family: 'DM Serif Display', serif;
    font-size: 14px;
    color: var(--accent);
    flex-shrink: 0;
  }
  .ending-end.irreg-ending { color: var(--irreg); }

  .example-verb {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.7;
  }
  .example-verb span { color: var(--text); font-weight: 500; }

  /* ======= SETTINGS PAGE ======= */
  #page-settings {
    padding: 24px 16px;
    align-items: center;
  }
  .settings-container {
    max-width: 600px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  .settings-header {
    font-family: 'DM Serif Display', serif;
    font-size: 30px;
    color: var(--text);
  }
  .settings-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .settings-section-title {
    padding: 14px 20px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }
  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    gap: 16px;
  }
  .settings-row:last-child { border-bottom: none; }
  .settings-row-label { font-size: 14px; font-weight: 500; }
  .settings-row-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

  /* Toggle */
  .toggle {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
  }
  .toggle-slider:before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    top: 3px;
    background: white;
    border-radius: 50%;
    transition: var(--transition);
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  input:checked + .toggle-slider { background: var(--accent); }
  input:checked + .toggle-slider:before { transform: translateX(20px); }

  /* Checkbox group */
  .checkbox-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 16px 20px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 10px;
    border-radius: 8px;
    transition: var(--transition);
  }
  .checkbox-item:hover { background: var(--bg); }
  .checkbox-item input { display: none; }
  .checkbox-box {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: var(--transition);
  }
  .checkbox-item input:checked ~ .checkbox-box {
    background: var(--accent);
    border-color: var(--accent);
  }
  .checkbox-item input:checked ~ .checkbox-box::after {
    content: 'âœ“';
    color: white;
    font-size: 11px;
    font-weight: 700;
  }
  .checkbox-label { font-size: 13px; font-weight: 500; }
  .checkbox-sublabel { font-size: 11px; color: var(--text-muted); }

  /* Animate card flip */
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-in { animation: fadeSlideUp 0.28s ease forwards; }

  @keyframes pulse {
    0%,100% { opacity: 1; } 50% { opacity: 0.5; }
  }
  .speaking { animation: pulse 0.6s ease infinite; }

  .lang-option-btn {
    padding: 8px 20px;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
  }
  .lang-option-btn:hover { border-color: var(--accent); color: var(--accent); }
  .lang-option-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
</style>
</head>
<body>

<nav>
  <div class="nav-logo">conjugar</div>
  <div class="nav-tabs">
    <button class="nav-tab active" id="nav-practice" onclick="showPage('practice')">Practice</button>
    <button class="nav-tab" id="nav-reference" onclick="showPage('reference')">Grammar</button>
    <button class="nav-tab" id="nav-settings" onclick="showPage('settings')">Settings</button>
  </div>
  <div class="nav-right"></div>
</nav>

<!-- ====== PRACTICE PAGE ====== -->
<div id="page-practice" class="page active">

  <div class="category-bar" id="categoryBar"></div>

  <div class="card-wrap">
    <div class="card" id="mainCard" onclick="handleCardClick()">
      <div class="card-stage-label" id="stageLabel">Presente</div>
      <button class="card-sound-btn" id="soundBtn" onclick="event.stopPropagation(); speakCurrent()" title="æœ—è¯»">ğŸ”Š</button>

      <div class="card-pre-reveal" id="preReveal">
        <div class="pronoun-badge" id="pronounBadge">yo</div>
        <div class="card-infinitive" id="infinitiveDisplay">hablar</div>
        <div class="card-meaning" id="meaningDisplay">to speak Â· è¯´/è®²è¯</div>
        <div class="card-level-badge" id="levelBadge">A1</div>
        <div class="click-hint" data-i18n="hint_reveal">ç‚¹å‡»æŸ¥çœ‹å˜ä½ Â· å†æ¬¡ç‚¹å‡»ä¸‹ä¸€é¢˜</div>
      </div>

      <div class="card-answer" id="answerReveal">
        <div class="pronoun-badge" id="answerPronoun">yo</div>
        <div class="conjugated-form" id="conjugatedForm">hablo</div>
        <div class="irreg-tag" id="irregTag" style="display:none" data-i18n="irregular_tag">ä¸è§„åˆ™ âš¡</div>
        <div class="card-meaning" id="answerMeaning">to speak Â· è¯´/è®²è¯</div>
        <div class="click-hint" style="margin-top:4px" data-i18n="hint_next">å†æ¬¡ç‚¹å‡»ä¸‹ä¸€é¢˜</div>
      </div>
    </div>
  </div>

  <div class="card-controls">
    <button class="nav-arrow-btn" onclick="prevCard()" title="ä¸Šä¸€ä¸ª">â†</button>
    <div class="progress-wrap" style="flex:1">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-count" id="progressCount">0 / 0</div>
    </div>
    <button class="nav-arrow-btn" onclick="nextCard()" title="ä¸‹ä¸€ä¸ª">â†’</button>
  </div>

</div>

<!-- ====== REFERENCE PAGE ====== -->
<div id="page-reference" class="page">
<div class="ref-container" id="refContainer">
  <!-- Rendered by buildReference() -->
</div>
</div>

<!-- ====== SETTINGS PAGE ====== -->
<div id="page-settings" class="page">
<div class="settings-container">
  <div class="settings-header" data-i18n="settings_title">è®¾ç½®</div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_tenses">æ—¶æ€é€‰æ‹©</div>
    <div class="checkbox-grid" id="tenseCheckboxes"></div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_pronouns">äººç§°ä»£è¯</div>
    <div class="checkbox-grid" id="pronounCheckboxes"></div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_level">è¯æ±‡çº§åˆ«</div>
    <div class="checkbox-grid" id="levelCheckboxes">
      <label class="checkbox-item">
        <input type="checkbox" id="levelA1" checked onchange="toggleVerbLevel('A1', this.checked)">
        <span class="checkbox-box"></span>
        <div>
          <div class="checkbox-label">A1</div>
          <div class="checkbox-sublabel" data-i18n="level_a1_sub">åŸºç¡€çº§åˆ«åŠ¨è¯</div>
        </div>
      </label>
      <label class="checkbox-item">
        <input type="checkbox" id="levelA2" checked onchange="toggleVerbLevel('A2', this.checked)">
        <span class="checkbox-box"></span>
        <div>
          <div class="checkbox-label">A2</div>
          <div class="checkbox-sublabel" data-i18n="level_a2_sub">è¿›é˜¶çº§åˆ«åŠ¨è¯</div>
        </div>
      </label>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_irreg">å˜åŒ–ç±»å‹</div>
    <div style="display:flex; flex-direction:column; gap:0">
      <label class="checkbox-item" style="padding:14px 20px; border-bottom:1px solid var(--border)">
        <input type="radio" name="irregFilter" value="all" checked onchange="setIrregFilter('all')" style="display:none">
        <span class="checkbox-box" id="rb-all" style="border-radius:50%">âœ“</span>
        <div>
          <div class="checkbox-label" data-i18n="irreg_all">å…¨éƒ¨</div>
          <div class="checkbox-sublabel" data-i18n="irreg_all_sub">è§„åˆ™ + ä¸è§„åˆ™</div>
        </div>
      </label>
      <label class="checkbox-item" style="padding:14px 20px; border-bottom:1px solid var(--border)">
        <input type="radio" name="irregFilter" value="regular" onchange="setIrregFilter('regular')" style="display:none">
        <span class="checkbox-box" id="rb-regular" style="border-radius:50%"></span>
        <div>
          <div class="checkbox-label" data-i18n="irreg_regular">åªç»ƒè§„åˆ™å˜åŒ–</div>
          <div class="checkbox-sublabel" data-i18n="irreg_regular_sub">è¯å°¾æŒ‰æ ‡å‡†è§„åˆ™å˜ä½çš„å½¢å¼</div>
        </div>
      </label>
      <label class="checkbox-item" style="padding:14px 20px">
        <input type="radio" name="irregFilter" value="irregular" onchange="setIrregFilter('irregular')" style="display:none">
        <span class="checkbox-box" id="rb-irregular" style="border-radius:50%"></span>
        <div>
          <div class="checkbox-label" data-i18n="irreg_irregular">åªç»ƒä¸è§„åˆ™å˜åŒ–</div>
          <div class="checkbox-sublabel" data-i18n="irreg_irregular_sub">æœ‰ç‰¹æ®Šå˜ä½çš„å½¢å¼ï¼ˆæ©™è‰²æ ‡æ³¨ï¼‰</div>
        </div>
      </label>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_speech">æœ—è¯»</div>
    <div class="settings-row">
      <div>
        <div class="settings-row-label" data-i18n="speech_auto">è‡ªåŠ¨æœ—è¯» Infinitivo</div>
        <div class="settings-row-sub" data-i18n="speech_auto_sub">ç¿»åˆ°æ–°å¡ç‰‡æ—¶è‡ªåŠ¨æœ—è¯»åŠ¨è¯åŸå½¢</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="toggleAutoSpeak" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="settings-row">
      <div>
        <div class="settings-row-label" data-i18n="speech_answer">æœ—è¯»å˜ä½ç»“æœ</div>
        <div class="settings-row-sub" data-i18n="speech_answer_sub">ç¿»å¼€ç­”æ¡ˆæ—¶è‡ªåŠ¨æœ—è¯»å˜ä½åçš„å½¢å¼</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="toggleSpeakAnswer">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_lang">ç•Œé¢è¯­è¨€</div>
    <div style="display:flex; gap:10px; padding:16px 20px;">
      <button class="lang-option-btn" id="lopt-zh" onclick="setLang('zh')">ä¸­æ–‡</button>
      <button class="lang-option-btn active" id="lopt-en" onclick="setLang('en')">English</button>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_appearance">å¤–è§‚</div>
    <div class="settings-row">
      <div>
        <div class="settings-row-label" data-i18n="dark_mode">æ·±è‰²æ¨¡å¼</div>
        <div class="settings-row-sub" data-i18n="dark_mode_sub">æŠ¤çœ¼ï¼Œé€‚åˆå¤œé—´å­¦ä¹ </div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="toggleDarkMode">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" data-i18n="settings_progress">å­¦ä¹ è¿›åº¦</div>
    <div id="progressStats" style="padding:16px 20px; display:flex; flex-direction:column; gap:12px;">
    </div>
    <div style="padding:0 20px 16px">
      <button onclick="resetProgress()" style="font-size:13px; color:var(--irreg); background:none; border:1px solid var(--irreg); border-radius:8px; padding:8px 16px; cursor:pointer; font-family:'DM Sans',sans-serif;" data-i18n="reset_progress">é‡ç½®è¿›åº¦</button>
    </div>
  </div>

</div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const TENSES = [
  { id: 'presente', name: 'Presente', level: 'A1', label: 'ç°åœ¨æ—¶ (A1)' },
  { id: 'perfecto', name: 'PretÃ©rito Perfecto', level: 'A2', label: 'è¿‘è¿‡å»æ—¶ (A2)' },
  { id: 'indefinido', name: 'PretÃ©rito Indefinido', level: 'A2', label: 'ç®€å•è¿‡å»æ—¶ (A2)' },
  { id: 'futuro', name: 'Futuro PrÃ³ximo', level: 'A1', label: 'è¿‘å°†æ¥ (A1)' },
  { id: 'reflexivo', name: 'Reflexivo (Pres.)', level: 'A1', label: 'åèº«åŠ¨è¯ç°åœ¨æ—¶ (A1)' },
  { id: 'imperativo', name: 'Imperativo', level: 'A2', label: 'å‘½ä»¤å¼ (A2)' },
];

const PRONOUNS = ['yo','tÃº','Ã©l/ella','nosotros','vosotros','ellos/ellas'];

const CATEGORIES = ['å…¨éƒ¨','æ—¥å¸¸åŠ¨è¯','é¥®é£Ÿ','è´­ç‰©','èŒä¸š','çˆ±å¥½','èº«ä½“/å¥åº·','å­¦ä¹ ','ç§»åŠ¨/äº¤é€š'];

// Each verb: { inf, en, zh, cat, level, forms: { presente, perfecto, indefinido, futuro }, irregular: { presente: [indices], ... } }
// irregular: array of pronoun indices that are irregular (0=yo,1=tÃº,2=Ã©l,3=nosotros,4=vosotros,5=ellos)
let VERBS = []; // loaded from verbs.json

// ============================================================
// STATE
// ============================================================
let state = {
  category: 'å…¨éƒ¨',
  activeTenses: ['presente'],
  activePronouns: [0,1,2,3,4,5],
  verbLevels: ['A1', 'A2'],
  irregFilter: 'all',
  autoSpeak: true,
  speakAnswer: false,
  queue: [],
  idx: 0,
  revealed: false,
};

// ============================================================
// REFERENCE PAGE
// ============================================================
const REF_CONTENT = {
  zh: {
    header: 'å˜ä½é€»è¾‘',
    subtitle: 'A1/A2 é˜¶æ®µæ‰€æœ‰æ—¶æ€çš„è§„åˆ™å˜ä½ + ä¸è§„åˆ™è¯´æ˜',
    blocks: [
      {
        name: 'Presente de Indicativo', level: 'A1', cls: 'level-a1',
        desc: 'æè¿°ç°åœ¨æ­£åœ¨å‘ç”Ÿçš„äº‹ã€ä¹ æƒ¯æ€§åŠ¨ä½œã€æˆ–ä¸€èˆ¬äº‹å®ã€‚ä¸‰ç±»åŠ¨è¯ï¼ˆ-AR / -ER / -IRï¼‰å„æœ‰ä¸€å¥—è¯å°¾ã€‚',
        groups: [
          { title: '-AR (hablar)', rows: [['yo','-o'],['tÃº','-as'],['Ã©l/ella','-a'],['nosotros','-amos'],['vosotros','-Ã¡is'],['ellos','-an']] },
          { title: '-ER (comer)', rows: [['yo','-o'],['tÃº','-es'],['Ã©l/ella','-e'],['nosotros','-emos'],['vosotros','-Ã©is'],['ellos','-en']] },
          { title: '-IR (vivir)', rows: [['yo','-o'],['tÃº','-es'],['Ã©l/ella','-e'],['nosotros','-imos'],['vosotros','-Ã­s'],['ellos','-en']] },
        ],
        note: 'âš¡ å¸¸è§ä¸è§„åˆ™ï¼šserâ†’soy/eres/esï¼Œestarâ†’estoy/estÃ¡s/estÃ¡ï¼Œirâ†’voy/vas/vaï¼Œtenerâ†’tengo/tienesï¼Œhacerâ†’hagoï¼ˆyoï¼‰ï¼Œquererâ†’quiero/quieresï¼ˆeâ†’ieï¼‰ï¼Œpoderâ†’puedo/puedesï¼ˆoâ†’ueï¼‰',
      },
      {
        name: 'PretÃ©rito Perfecto Compuesto', level: 'A2', cls: 'level-a2',
        desc: 'è¡¨è¾¾ä¸ç°åœ¨æœ‰å…³è”çš„è¿‡å»è¡Œä¸ºï¼Œå¸¸ä¸ hoy / esta semana / ya / nunca / alguna vez è¿ç”¨ã€‚æ„æˆï¼šhaberï¼ˆç°åœ¨æ—¶ï¼‰+ è¿‡å»åˆ†è¯ã€‚',
        groups: [
          { title: 'haber (ç°åœ¨æ—¶)', rows: [['yo','he'],['tÃº','has'],['Ã©l/ella','ha'],['nosotros','hemos'],['vosotros','habÃ©is'],['ellos','han']] },
          { title: 'è§„åˆ™è¿‡å»åˆ†è¯', rows: [['-AR','-ado'],['-ER','-ido'],['-IR','-ido']], note: 'hablarâ†’hablado\ncomerâ†’comido\nvivirâ†’vivido' },
          { title: 'ä¸è§„åˆ™è¿‡å»åˆ†è¯', rows: [['hacer','hecho'],['ver','visto'],['decir','dicho'],['escribir','escrito'],['poner','puesto'],['volver','vuelto']], irreg: true },
        ],
        note: '',
      },
      {
        name: 'PretÃ©rito Indefinido', level: 'A2', cls: 'level-a2',
        desc: 'è¡¨è¾¾å·²å®Œæˆçš„ã€ä¸ç°åœ¨æ— å…³è”çš„è¿‡å»è¡Œä¸ºï¼Œå¸¸ä¸ ayer / la semana pasada / en 2020 / hace X aÃ±os è¿ç”¨ã€‚',
        groups: [
          { title: '-AR (hablar)', rows: [['yo','-Ã©'],['tÃº','-aste'],['Ã©l/ella','-Ã³'],['nosotros','-amos'],['vosotros','-asteis'],['ellos','-aron']] },
          { title: '-ER/-IR (comer/vivir)', rows: [['yo','-Ã­'],['tÃº','-iste'],['Ã©l/ella','-iÃ³'],['nosotros','-imos'],['vosotros','-isteis'],['ellos','-ieron']] },
          { title: 'å®Œå…¨ä¸è§„åˆ™', rows: [['ser/ir','fui/fue'],['tener','tuve'],['estar','estuve'],['hacer','hice'],['poder','pude'],['decir','dije']], irreg: true },
        ],
        note: '',
      },
      {
        name: 'Futuro PrÃ³ximo (ir a + inf)', level: 'A1', cls: 'level-a1',
        desc: 'è¡¨è¾¾è®¡åˆ’æˆ–å°†è¦å‘ç”Ÿçš„äº‹ã€‚æ„æˆï¼širï¼ˆç°åœ¨æ—¶ï¼‰+ a + åŠ¨è¯åŸå½¢ã€‚',
        groups: [
          { title: 'ir (ç°åœ¨æ—¶)', rows: [['yo','voy'],['tÃº','vas'],['Ã©l/ella','va'],['nosotros','vamos'],['vosotros','vais'],['ellos','van']], irreg: true },
          { title: 'ä¾‹å¥', span2: true, examples: ['Voy a comer â†’ æˆ‘è¦å»åƒ','Vas a estudiar â†’ ä½ è¦å»å­¦ä¹ ','Va a llover â†’ è¦ä¸‹é›¨äº†','Vamos a hablar â†’ æˆ‘ä»¬æ¥è¯´è¯´'] },
        ],
        note: '',
      },
      {
        name: 'Verbos Reflexivos', level: 'A1', cls: 'level-a1',
        desc: 'åèº«åŠ¨è¯è¡¨ç¤ºåŠ¨ä½œä½œç”¨äºä¸»è¯­è‡ªèº«ã€‚åœ¨åŠ¨è¯åŸå½¢å‰åŠ åèº«ä»£è¯ï¼ˆme/te/se/nos/os/seï¼‰ï¼Œå˜ä½åä»£è¯æ”¾åœ¨å˜ä½åŠ¨è¯å‰ã€‚',
        groups: [
          { title: 'åèº«ä»£è¯', rows: [['yo','me'],['tÃº','te'],['Ã©l/ella','se'],['nosotros','nos'],['vosotros','os'],['ellos','se']] },
          { title: 'levantarse (è§„åˆ™)', rows: [['yo','me levanto'],['tÃº','te levantas'],['Ã©l/ella','se levanta'],['nosotros','nos levantamos'],['vosotros','os levantÃ¡is'],['ellos','se levantan']] },
          { title: 'vestirse (ä¸è§„åˆ™ eâ†’i)', rows: [['yo','me visto'],['tÃº','te vistes'],['Ã©l/ella','se viste'],['nosotros','nos vestimos'],['vosotros','os vestÃ­s'],['ellos','se visten']], irreg: true },
        ],
        note: 'âš¡ å¸¸è§åèº«åŠ¨è¯ï¼šlevantarseï¼ˆèµ·åºŠï¼‰ã€acostarseï¼ˆç¡è§‰ï¼‰ã€ducharseï¼ˆæ´—æ¾¡ï¼‰ã€vestirseï¼ˆç©¿è¡£ï¼‰ã€despertarseï¼ˆé†’æ¥ï¼‰ã€llamarseï¼ˆå«åšï¼‰ã€sentirseï¼ˆæ„Ÿè§‰ï¼‰ã€ponerseï¼ˆç©¿ä¸Šï¼‰',
      },
      {
        name: 'Imperativo (Afirmativo)', level: 'A2', cls: 'level-a2',
        desc: 'å‘½ä»¤å¼ç”¨äºæŒ‡ä»¤ã€è¯·æ±‚ã€å»ºè®®ã€‚è‚¯å®šå‘½ä»¤å¼æ²¡æœ‰ yo å½¢å¼ã€‚tÃº å½¢å¼é€šå¸¸ç­‰äºç¬¬ä¸‰äººç§°å•æ•°ç°åœ¨æ—¶ï¼›vosotros å½¢å¼æŠŠåŸå½¢è¯å°¾ -r æ¢æˆ -dã€‚',
        groups: [
          { title: '-AR è§„åˆ™ (hablar)', rows: [['tÃº','habla'],['usted','hable'],['nosotros','hablemos'],['vosotros','hablad'],['ustedes','hablen']] },
          { title: '-ER/-IR è§„åˆ™ (comer)', rows: [['tÃº','come'],['usted','coma'],['nosotros','comamos'],['vosotros','comed'],['ustedes','coman']] },
          { title: 'ä¸è§„åˆ™ tÃº å½¢å¼', rows: [['ir','ve'],['hacer','haz'],['tener','ten'],['ser','sÃ©'],['poner','pon'],['decir','di'],['venir','ven']], irreg: true },
        ],
        note: 'âš¡ åèº«åŠ¨è¯å‘½ä»¤å¼ï¼šlevÃ¡ntateï¼ˆtÃºï¼‰ã€levantÃ©monosï¼ˆnosotrosï¼‰ã€levantaosï¼ˆvosotrosï¼‰ã€‚ä»£è¯é™„åŠ åœ¨åŠ¨è¯æœ«å°¾ã€‚',
      },
    ],
  },
  en: {
    header: 'Grammar Logic',
    subtitle: 'Conjugation rules for all A1/A2 tenses with irregular forms highlighted',
    blocks: [
      {
        name: 'Presente de Indicativo', level: 'A1', cls: 'level-a1',
        desc: 'Used for current actions, habits, and general facts. Three verb classes (-AR / -ER / -IR) each have their own set of endings.',
        groups: [
          { title: '-AR (hablar)', rows: [['yo','-o'],['tÃº','-as'],['Ã©l/ella','-a'],['nosotros','-amos'],['vosotros','-Ã¡is'],['ellos','-an']] },
          { title: '-ER (comer)', rows: [['yo','-o'],['tÃº','-es'],['Ã©l/ella','-e'],['nosotros','-emos'],['vosotros','-Ã©is'],['ellos','-en']] },
          { title: '-IR (vivir)', rows: [['yo','-o'],['tÃº','-es'],['Ã©l/ella','-e'],['nosotros','-imos'],['vosotros','-Ã­s'],['ellos','-en']] },
        ],
        note: 'âš¡ Common irregulars: serâ†’soy/eres/es, estarâ†’estoy/estÃ¡s/estÃ¡, irâ†’voy/vas/va, tenerâ†’tengo/tienes, hacerâ†’hago (yo only), quererâ†’quiero/quieres (eâ†’ie), poderâ†’puedo/puedes (oâ†’ue)',
      },
      {
        name: 'PretÃ©rito Perfecto Compuesto', level: 'A2', cls: 'level-a2',
        desc: 'Expresses past actions connected to the present. Common time markers: hoy / esta semana / ya / nunca / alguna vez. Formed with: haber (present) + past participle.',
        groups: [
          { title: 'haber (present)', rows: [['yo','he'],['tÃº','has'],['Ã©l/ella','ha'],['nosotros','hemos'],['vosotros','habÃ©is'],['ellos','han']] },
          { title: 'Regular participles', rows: [['-AR','-ado'],['-ER','-ido'],['-IR','-ido']], note: 'hablarâ†’hablado\ncomerâ†’comido\nvivirâ†’vivido' },
          { title: 'Irregular participles', rows: [['hacer','hecho'],['ver','visto'],['decir','dicho'],['escribir','escrito'],['poner','puesto'],['volver','vuelto']], irreg: true },
        ],
        note: '',
      },
      {
        name: 'PretÃ©rito Indefinido', level: 'A2', cls: 'level-a2',
        desc: 'Expresses completed past actions with no connection to the present. Common time markers: ayer / la semana pasada / en 2020 / hace X aÃ±os.',
        groups: [
          { title: '-AR (hablar)', rows: [['yo','-Ã©'],['tÃº','-aste'],['Ã©l/ella','-Ã³'],['nosotros','-amos'],['vosotros','-asteis'],['ellos','-aron']] },
          { title: '-ER/-IR (comer/vivir)', rows: [['yo','-Ã­'],['tÃº','-iste'],['Ã©l/ella','-iÃ³'],['nosotros','-imos'],['vosotros','-isteis'],['ellos','-ieron']] },
          { title: 'Fully irregular', rows: [['ser/ir','fui/fue'],['tener','tuve'],['estar','estuve'],['hacer','hice'],['poder','pude'],['decir','dije']], irreg: true },
        ],
        note: '',
      },
      {
        name: 'Futuro PrÃ³ximo (ir a + inf)', level: 'A1', cls: 'level-a1',
        desc: 'Expresses plans or intentions. Formed with: ir (present tense) + a + infinitive.',
        groups: [
          { title: 'ir (present)', rows: [['yo','voy'],['tÃº','vas'],['Ã©l/ella','va'],['nosotros','vamos'],['vosotros','vais'],['ellos','van']], irreg: true },
          { title: 'Examples', span2: true, examples: ['Voy a comer â†’ I am going to eat','Vas a estudiar â†’ You are going to study','Va a llover â†’ It is going to rain','Vamos a hablar â†’ We are going to talk'] },
        ],
        note: '',
      },
      {
        name: 'Verbos Reflexivos', level: 'A1', cls: 'level-a1',
        desc: 'Reflexive verbs express actions done to oneself. A reflexive pronoun (me/te/se/nos/os/se) is added and placed before the conjugated verb.',
        groups: [
          { title: 'Reflexive pronouns', rows: [['yo','me'],['tÃº','te'],['Ã©l/ella','se'],['nosotros','nos'],['vosotros','os'],['ellos','se']] },
          { title: 'levantarse (regular)', rows: [['yo','me levanto'],['tÃº','te levantas'],['Ã©l/ella','se levanta'],['nosotros','nos levantamos'],['vosotros','os levantÃ¡is'],['ellos','se levantan']] },
          { title: 'vestirse (irregular eâ†’i)', rows: [['yo','me visto'],['tÃº','te vistes'],['Ã©l/ella','se viste'],['nosotros','nos vestimos'],['vosotros','os vestÃ­s'],['ellos','se visten']], irreg: true },
        ],
        note: 'âš¡ Common reflexive verbs: levantarse (to get up), acostarse (to go to bed), ducharse (to shower), vestirse (to get dressed), despertarse (to wake up), llamarse (to be called), sentirse (to feel), ponerse (to put on)',
      },
      {
        name: 'Imperativo (Afirmativo)', level: 'A2', cls: 'level-a2',
        desc: 'The imperative is used for commands, requests, and suggestions. There is no yo form. The tÃº form usually matches the 3rd person singular present. The vosotros form replaces the final -r of the infinitive with -d.',
        groups: [
          { title: '-AR regular (hablar)', rows: [['tÃº','habla'],['usted','hable'],['nosotros','hablemos'],['vosotros','hablad'],['ustedes','hablen']] },
          { title: '-ER/-IR regular (comer)', rows: [['tÃº','come'],['usted','coma'],['nosotros','comamos'],['vosotros','comed'],['ustedes','coman']] },
          { title: 'Irregular tÃº forms', rows: [['ir','ve'],['hacer','haz'],['tener','ten'],['ser','sÃ©'],['poner','pon'],['decir','di'],['venir','ven']], irreg: true },
        ],
        note: 'âš¡ Reflexive imperatives: levÃ¡ntate (tÃº), levantÃ©monos (nosotros), levantaos (vosotros). The reflexive pronoun attaches to the end of the verb.',
      },
    ],
  },
};

function buildReference() {
  const data = REF_CONTENT[currentLang] || REF_CONTENT.en;
  const container = document.getElementById('refContainer');
  if (!container) return;

  const rowHTML = (rows, irreg) => rows.map(([p, e]) =>
    `<div class="ending-row"><span class="ending-pron">${p}</span><span class="ending-end${irreg?' irreg-ending':''}">${e}</span></div>`
  ).join('');

  const groupHTML = (g) => {
    if (g.span2) {
      return `<div class="ending-group" style="grid-column:span 2">
        <div class="ending-group-title">${g.title}</div>
        ${g.examples.map(e=>`<div style="font-size:13px;line-height:2.2">${e}</div>`).join('')}
      </div>`;
    }
    return `<div class="ending-group">
      <div class="ending-group-title">${g.title}</div>
      ${rowHTML(g.rows, g.irreg)}
      ${g.note ? `<div style="margin-top:8px;font-size:12px;color:var(--text-muted);white-space:pre-line">${g.note}</div>` : ''}
    </div>`;
  };

  const blockHTML = (b) => `
    <div class="tense-block">
      <div class="tense-block-header">
        <div class="tense-name">${b.name}</div>
        <div class="tense-level ${b.cls}">${b.level}</div>
      </div>
      <div class="tense-block-body">
        <div class="tense-desc">${b.desc}</div>
        <div class="endings-grid">${b.groups.map(groupHTML).join('')}</div>
        ${b.note ? `<div class="example-verb">${b.note}</div>` : ''}
      </div>
    </div>`;

  container.innerHTML = `
    <div>
      <div class="ref-header">${data.header}</div>
      <div class="ref-subtitle">${data.subtitle}</div>
    </div>
    ${data.blocks.map(blockHTML).join('')}
  `;
}

// ============================================================
// PERSISTENCE â€” localStorage
// ============================================================
const LS_SETTINGS = 'conjugar_settings';
const LS_PROGRESS = 'conjugar_progress';

function saveSettings() {
  const s = {
    category: state.category,
    activeTenses: state.activeTenses,
    activePronouns: state.activePronouns,
    verbLevels: state.verbLevels,
    irregFilter: state.irregFilter,
    autoSpeak: state.autoSpeak,
    speakAnswer: state.speakAnswer,
    lang: currentLang,
    darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
  };
  localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
}

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_SETTINGS));
    if (!s) return;
    if (s.category) state.category = s.category;
    if (s.activeTenses) state.activeTenses = s.activeTenses;
    if (s.activePronouns) state.activePronouns = s.activePronouns;
    if (s.verbLevels) state.verbLevels = s.verbLevels;
    if (s.irregFilter) state.irregFilter = s.irregFilter;
    if (typeof s.autoSpeak === 'boolean') state.autoSpeak = s.autoSpeak;
    if (typeof s.speakAnswer === 'boolean') state.speakAnswer = s.speakAnswer;
    if (s.lang) currentLang = s.lang;
    if (s.darkMode) applyDarkMode(true, false);
  } catch(e) {}
}

function syncSettingsUI() {
  // toggles
  document.getElementById('toggleAutoSpeak').checked = state.autoSpeak;
  document.getElementById('toggleSpeakAnswer').checked = state.speakAnswer;
  document.getElementById('toggleDarkMode').checked =
    document.documentElement.getAttribute('data-theme') === 'dark';
  // level checkboxes
  document.getElementById('levelA1').checked = state.verbLevels.includes('A1');
  document.getElementById('levelA2').checked = state.verbLevels.includes('A2');
  // irregFilter radio
  setIrregFilter(state.irregFilter);
}

// â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyDarkMode(on, save = true) {
  document.documentElement.setAttribute('data-theme', on ? 'dark' : 'light');
  const toggle = document.getElementById('toggleDarkMode');
  if (toggle) toggle.checked = on;
  // update theme-color meta for Android Chrome
  document.querySelector('meta[name="theme-color"]').content = on ? '#141210' : '#2D5016';
  if (save) saveSettings();
}

document.getElementById('toggleDarkMode').addEventListener('change', function() {
  applyDarkMode(this.checked);
});

// â”€â”€ Progress tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTodayKey() {
  return new Date().toISOString().slice(0, 10); // "2025-02-20"
}

function loadProgress() {
  try { return JSON.parse(localStorage.getItem(LS_PROGRESS)) || {}; } catch(e) { return {}; }
}

function saveProgress(p) {
  localStorage.setItem(LS_PROGRESS, JSON.stringify(p));
}

function recordCard() {
  const p = loadProgress();
  const today = getTodayKey();
  p.total = (p.total || 0) + 1;
  p.byDay = p.byDay || {};
  p.byDay[today] = (p.byDay[today] || 0) + 1;
  // streak: count consecutive days up to today
  p.streak = calcStreak(p.byDay);
  saveProgress(p);
  renderProgressStats();
}

function calcStreak(byDay) {
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const key = d.toISOString().slice(0, 10);
    if (byDay[key]) { streak++; d.setDate(d.getDate() - 1); }
    else if (i === 0) { d.setDate(d.getDate() - 1); } // today not yet practiced â†’ check yesterday
    else break;
  }
  return streak;
}

function renderProgressStats() {
  const el = document.getElementById('progressStats');
  if (!el) return;
  const p = loadProgress();
  const today = getTodayKey();
  const todayCount = (p.byDay || {})[today] || 0;
  const stat = (label, value) =>
    `<div style="display:flex;justify-content:space-between;align-items:center;font-size:14px">
      <span style="color:var(--text-muted)">${label}</span>
      <span style="font-weight:600;font-size:16px;color:var(--accent)">${value}</span>
    </div>`;
  el.innerHTML =
    stat(t('progress_today'), `${todayCount} ${t('progress_cards')}`) +
    stat(t('progress_total'), `${p.total || 0} ${t('progress_cards')}`) +
    stat(t('progress_streak'), `${p.streak || 0} ${t('progress_days')}`);
}

function resetProgress() {
  localStorage.removeItem(LS_PROGRESS);
  renderProgressStats();
}

// ============================================================
// INIT
// ============================================================

function buildCategoryBar() {
  const bar = document.getElementById('categoryBar');
  const cats = t('cats');
  const internalCats = ['å…¨éƒ¨','æ—¥å¸¸åŠ¨è¯','é¥®é£Ÿ','è´­ç‰©','èŒä¸š','çˆ±å¥½','èº«ä½“/å¥åº·','å­¦ä¹ ','ç§»åŠ¨/äº¤é€š'];
  bar.innerHTML = internalCats.map((c, i) =>
    `<button class="cat-btn${c===state.category?' active':''}" data-cat="${c}" onclick="selectCategory('${c}')">${cats[i]}</button>`
  ).join('');
}

function buildTenseCheckboxes() {
  const container = document.getElementById('tenseCheckboxes');
  const tenseLabels = t('tense_labels');
  container.innerHTML = TENSES.map(tns => `
    <label class="checkbox-item">
      <input type="checkbox" ${state.activeTenses.includes(tns.id)?'checked':''} onchange="toggleTense('${tns.id}', this.checked)">
      <span class="checkbox-box"></span>
      <div>
        <div class="checkbox-label">${tns.name}</div>
        <div class="checkbox-sublabel">${tenseLabels[tns.id] || tns.label}</div>
      </div>
    </label>
  `).join('');
}

function buildPronounCheckboxes() {
  const container = document.getElementById('pronounCheckboxes');
  container.innerHTML = PRONOUNS.map((p, i) => `
    <label class="checkbox-item">
      <input type="checkbox" ${state.activePronouns.includes(i)?'checked':''} onchange="togglePronoun(${i}, this.checked)">
      <span class="checkbox-box"></span>
      <div><div class="checkbox-label">${p}</div></div>
    </label>
  `).join('');
}

function selectCategory(cat) {
  state.category = cat;
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.getAttribute('data-cat') === cat));
  saveSettings();
  buildQueue();
  renderCard();
}

function toggleTense(id, checked) {
  if (checked) { if (!state.activeTenses.includes(id)) state.activeTenses.push(id); }
  else { state.activeTenses = state.activeTenses.filter(t => t !== id); }
  if (state.activeTenses.length === 0) { state.activeTenses = [id]; buildTenseCheckboxes(); }
  saveSettings();
  buildQueue();
  renderCard();
}

function togglePronoun(idx, checked) {
  if (checked) { if (!state.activePronouns.includes(idx)) state.activePronouns.push(idx); }
  else { state.activePronouns = state.activePronouns.filter(i => i !== idx); }
  if (state.activePronouns.length === 0) { state.activePronouns = [idx]; buildPronounCheckboxes(); }
  saveSettings();
  buildQueue();
  renderCard();
}

function buildQueue() {
  let verbs = state.category === 'å…¨éƒ¨' ? VERBS : VERBS.filter(v => v.cat === state.category);
  verbs = verbs.filter(v => state.verbLevels.includes(v.level));

  const items = [];
  verbs.forEach(v => {
    state.activeTenses.forEach(t => {
      if (!v.forms[t]) return;
      state.activePronouns.forEach(pi => {
        const form = v.forms[t][pi];
        if (!form || form === 'â€”') return; // skip placeholder
        const isIrreg = (v.irregular[t] || []).includes(pi);
        if (state.irregFilter === 'regular' && isIrreg) return;
        if (state.irregFilter === 'irregular' && !isIrreg) return;
        items.push({ verb: v, tense: t, pronIdx: pi });
      });
    });
  });
  // Shuffle
  for (let i = items.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [items[i], items[j]] = [items[j], items[i]];
  }
  state.queue = items;
  state.idx = 0;
  state.revealed = false;
  updateProgress();
}

const IMPERATIVO_LABELS = ['(yo â€”)','tÃº','usted','nosotros','vosotros','ustedes'];
const REFLEXIVO_LABELS = ['yo','tÃº','Ã©l/ella','nosotros','vosotros','ellos/ellas'];

function renderCard() {
  if (state.queue.length === 0) {
    document.getElementById('infinitiveDisplay').textContent = t('no_cards');
    document.getElementById('meaningDisplay').textContent = t('no_cards_sub');
    document.getElementById('stageLabel').textContent = 'â€”';
    return;
  }
  const item = state.queue[state.idx % state.queue.length];
  const { verb, tense, pronIdx } = item;
  const form = verb.forms[tense][pronIdx];
  const isIrreg = (verb.irregular[tense] || []).includes(pronIdx);
  const tenseMeta = TENSES.find(t => t.id === tense);

  // Choose pronoun label based on tense
  let pronLabel;
  if (tense === 'imperativo') pronLabel = IMPERATIVO_LABELS[pronIdx];
  else pronLabel = PRONOUNS[pronIdx];

  // Meaning text â€” show zh only if current lang is zh
  const meaning = TRANSLATIONS[currentLang].show_zh
    ? `${item.verb.en} Â· ${item.verb.zh}`
    : item.verb.en;

  document.getElementById('stageLabel').textContent = tenseMeta ? tenseMeta.name : tense;
  document.getElementById('pronounBadge').textContent = pronLabel;
  document.getElementById('infinitiveDisplay').textContent = item.verb.inf;
  document.getElementById('meaningDisplay').textContent = meaning;
  const lvlBadge = document.getElementById('levelBadge');
  lvlBadge.textContent = item.verb.level;
  lvlBadge.className = 'card-level-badge ' + (item.verb.level === 'A1' ? 'level-a1' : 'level-a2');

  document.getElementById('answerPronoun').textContent = pronLabel;
  const conjEl = document.getElementById('conjugatedForm');
  conjEl.textContent = form;
  conjEl.className = 'conjugated-form' + (isIrreg ? ' irregular' : '');
  const irregTagEl = document.getElementById('irregTag');
  irregTagEl.style.display = isIrreg ? 'inline-block' : 'none';
  irregTagEl.textContent = t('irregular_tag');
  document.getElementById('answerMeaning').textContent = meaning;

  // Hide answer
  const card = document.getElementById('mainCard');
  card.classList.remove('revealed');
  state.revealed = false;

  // Animate
  card.classList.remove('animate-in');
  void card.offsetWidth;
  card.classList.add('animate-in');

  updateProgress();

  // Auto speak â€” only when on practice page
  if (state.autoSpeak && currentPage === 'practice') {
    setTimeout(() => speakText(item.verb.inf), 200);
  }
}

function handleCardClick() {
  if (!state.revealed) {
    document.getElementById('mainCard').classList.add('revealed');
    state.revealed = true;
    if (state.speakAnswer && currentPage === 'practice') {
      const item = state.queue[state.idx % state.queue.length];
      speakText(item.verb.forms[item.tense][item.pronIdx]);
    }
  } else {
    nextCard();
  }
}

function nextCard() {
  state.idx = (state.idx + 1) % state.queue.length;
  recordCard();
  renderCard();
}

function prevCard() {
  state.idx = (state.idx - 1 + state.queue.length) % state.queue.length;
  renderCard();
}

function updateProgress() {
  const total = state.queue.length;
  const cur = state.idx + 1;
  const pct = total > 0 ? (cur / total) * 100 : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressCount').textContent = `${cur} / ${total}`;
}

// ============================================================
// SPEECH
// ============================================================
let cachedVoice = null;

function loadVoice() {
  const voices = window.speechSynthesis.getVoices();
  if (!voices.length) return;
  cachedVoice =
    voices.find(v => v.lang.startsWith('es') && v.name.includes('Google')) ||
    voices.find(v => v.lang === 'es-ES') ||
    voices.find(v => v.lang.startsWith('es')) ||
    null;
}

window.speechSynthesis.onvoiceschanged = () => { loadVoice(); };
// Also try immediately (works on desktop)
loadVoice();

function speakText(text) {
  if (!window.speechSynthesis) return;
  try {
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = 'es-ES';
    utt.rate = 0.9;
    if (cachedVoice) utt.voice = cachedVoice;
    // Android workaround: re-attempt if voices not ready yet
    if (!cachedVoice) {
      loadVoice();
      if (cachedVoice) utt.voice = cachedVoice;
    }
    const btn = document.getElementById('soundBtn');
    if (btn) { btn.classList.add('speaking'); utt.onend = () => btn.classList.remove('speaking'); }
    window.speechSynthesis.speak(utt);
  } catch(e) {}
}

function speakCurrent() {
  const item = state.queue[state.idx % state.queue.length];
  if (!item) return;
  const text = state.revealed ? item.verb.forms[item.tense][item.pronIdx] : item.verb.inf;
  speakText(text);
}

// ============================================================
// SETTINGS SYNC
// ============================================================
document.getElementById('toggleAutoSpeak').addEventListener('change', function() {
  state.autoSpeak = this.checked;
  saveSettings();
});
document.getElementById('toggleSpeakAnswer').addEventListener('change', function() {
  state.speakAnswer = this.checked;
  saveSettings();
});

function toggleVerbLevel(level, checked) {
  if (checked) { if (!state.verbLevels.includes(level)) state.verbLevels.push(level); }
  else { state.verbLevels = state.verbLevels.filter(l => l !== level); }
  if (state.verbLevels.length === 0) {
    state.verbLevels = [level];
    document.getElementById('level' + level).checked = true;
  }
  saveSettings();
  buildQueue(); renderCard();
}

function setIrregFilter(val) {
  state.irregFilter = val;
  ['all','regular','irregular'].forEach(v => {
    const el = document.getElementById('rb-' + v);
    if (el) {
      el.style.background = v === val ? 'var(--accent)' : '';
      el.style.borderColor = v === val ? 'var(--accent)' : '';
      el.innerHTML = v === val ? '<span style="color:white;font-size:11px;font-weight:700">âœ“</span>' : '';
    }
  });
  saveSettings();
  buildQueue(); renderCard();
}

// ============================================================
// PAGE NAV
// ============================================================
let currentPage = 'practice';

function showPage(id) {
  currentPage = id;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach((tab, i) => {
    tab.classList.toggle('active', ['practice','reference','settings'][i] === id);
  });
  if (id === 'practice' && state.autoSpeak && state.queue.length > 0) {
    const item = state.queue[state.idx % state.queue.length];
    setTimeout(() => speakText(item.verb.inf), 150);
  }
  if (id === 'settings') renderProgressStats();
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', e => {
  if (e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    handleCardClick();
  }
  if (e.key === 'ArrowRight') nextCard();
  if (e.key === 'ArrowLeft') prevCard();
  if (e.key === 's' || e.key === 'S') speakCurrent();
});

// ============================================================
// I18N â€” TRANSLATIONS
// ============================================================
const TRANSLATIONS = {
  zh: {
    nav_practice: 'ç»ƒä¹ ',
    nav_reference: 'è¯­æ³•é€»è¾‘',
    nav_settings: 'è®¾ç½®',
    settings_title: 'è®¾ç½®',
    settings_tenses: 'æ—¶æ€é€‰æ‹©',
    settings_pronouns: 'äººç§°ä»£è¯',
    settings_level: 'è¯æ±‡çº§åˆ«',
    settings_irreg: 'å˜åŒ–ç±»å‹',
    settings_speech: 'æœ—è¯»',
    settings_lang: 'ç•Œé¢è¯­è¨€',
    level_a1_sub: 'åŸºç¡€çº§åˆ«åŠ¨è¯',
    level_a2_sub: 'è¿›é˜¶çº§åˆ«åŠ¨è¯',
    irreg_all: 'å…¨éƒ¨',
    irreg_all_sub: 'è§„åˆ™ + ä¸è§„åˆ™',
    irreg_regular: 'åªç»ƒè§„åˆ™å˜åŒ–',
    irreg_regular_sub: 'è¯å°¾æŒ‰æ ‡å‡†è§„åˆ™å˜ä½çš„å½¢å¼',
    irreg_irregular: 'åªç»ƒä¸è§„åˆ™å˜åŒ–',
    irreg_irregular_sub: 'æœ‰ç‰¹æ®Šå˜ä½çš„å½¢å¼ï¼ˆæ©™è‰²æ ‡æ³¨ï¼‰',
    speech_auto: 'è‡ªåŠ¨æœ—è¯» Infinitivo',
    speech_auto_sub: 'ç¿»åˆ°æ–°å¡ç‰‡æ—¶è‡ªåŠ¨æœ—è¯»åŠ¨è¯åŸå½¢',
    speech_answer: 'æœ—è¯»å˜ä½ç»“æœ',
    speech_answer_sub: 'ç¿»å¼€ç­”æ¡ˆæ—¶è‡ªåŠ¨æœ—è¯»å˜ä½åçš„å½¢å¼',
    hint_reveal: 'ç‚¹å‡»æŸ¥çœ‹å˜ä½ Â· å†æ¬¡ç‚¹å‡»ä¸‹ä¸€é¢˜',
    hint_next: 'å†æ¬¡ç‚¹å‡»ä¸‹ä¸€é¢˜',
    irregular_tag: 'ä¸è§„åˆ™ âš¡',
    no_cards: 'æ— å¡ç‰‡',
    no_cards_sub: 'è¯·è°ƒæ•´ç±»åˆ«æˆ–è®¾ç½®',
    cat_all: 'å…¨éƒ¨',
    cats: ['å…¨éƒ¨','æ—¥å¸¸åŠ¨è¯','é¥®é£Ÿ','è´­ç‰©','èŒä¸š','çˆ±å¥½','èº«ä½“/å¥åº·','å­¦ä¹ ','ç§»åŠ¨/äº¤é€š'],
    tense_labels: {
      presente: 'ç°åœ¨æ—¶ (A1)',
      perfecto: 'è¿‘è¿‡å»æ—¶ (A2)',
      indefinido: 'ç®€å•è¿‡å»æ—¶ (A2)',
      futuro: 'è¿‘å°†æ¥ (A1)',
      reflexivo: 'åèº«åŠ¨è¯ç°åœ¨æ—¶ (A1)',
      imperativo: 'å‘½ä»¤å¼ (A2)',
    },
    meaning_sep: ' Â· ',   // separator between en and zh in card
    show_zh: true,
    settings_appearance: 'å¤–è§‚',
    dark_mode: 'æ·±è‰²æ¨¡å¼',
    dark_mode_sub: 'æŠ¤çœ¼ï¼Œé€‚åˆå¤œé—´å­¦ä¹ ',
    settings_progress: 'å­¦ä¹ è¿›åº¦',
    reset_progress: 'é‡ç½®è¿›åº¦',
    progress_today: 'ä»Šå¤©ç»ƒä¹ ',
    progress_total: 'ç´¯è®¡ç»ƒä¹ ',
    progress_streak: 'è¿ç»­å¤©æ•°',
    progress_cards: 'å¼ å¡ç‰‡',
    progress_days: 'å¤©',
  },
  en: {
    nav_practice: 'Practice',
    nav_reference: 'Grammar',
    nav_settings: 'Settings',
    settings_title: 'Settings',
    settings_tenses: 'Tenses',
    settings_pronouns: 'Pronouns',
    settings_level: 'Vocabulary Level',
    settings_irreg: 'Conjugation Type',
    settings_speech: 'Audio',
    settings_lang: 'Interface Language',
    level_a1_sub: 'Beginner verbs',
    level_a2_sub: 'Elementary verbs',
    irreg_all: 'All',
    irreg_all_sub: 'Regular + irregular',
    irreg_regular: 'Regular only',
    irreg_regular_sub: 'Standard endings only',
    irreg_irregular: 'Irregular only',
    irreg_irregular_sub: 'Special forms (shown in orange)',
    speech_auto: 'Auto-read Infinitive',
    speech_auto_sub: 'Reads the infinitive when a new card appears',
    speech_answer: 'Read conjugated form',
    speech_answer_sub: 'Reads the answer when the card is flipped',
    hint_reveal: 'Tap to reveal Â· Tap again for next',
    hint_next: 'Tap again for next',
    irregular_tag: 'Irregular âš¡',
    no_cards: 'No cards',
    no_cards_sub: 'Adjust category or settings',
    cat_all: 'All',
    cats: ['All','Daily','Food & Drink','Shopping','Professions','Hobbies','Health','Studying','Transport'],
    tense_labels: {
      presente: 'Present tense (A1)',
      perfecto: 'Perfect tense (A2)',
      indefinido: 'Preterite (A2)',
      futuro: 'Near future (A1)',
      reflexivo: 'Reflexive present (A1)',
      imperativo: 'Imperative (A2)',
    },
    meaning_sep: ' Â· ',
    show_zh: false,
    settings_appearance: 'Appearance',
    dark_mode: 'Dark mode',
    dark_mode_sub: 'Easier on the eyes at night',
    settings_progress: 'Progress',
    reset_progress: 'Reset progress',
    progress_today: 'Today',
    progress_total: 'Total',
    progress_streak: 'Streak',
    progress_cards: 'cards',
    progress_days: 'days',
  },
};

let currentLang = 'en';

function t(key) {
  return TRANSLATIONS[currentLang][key] || TRANSLATIONS['zh'][key] || key;
}

function setLang(lang) {
  currentLang = lang;

  // Update settings language option buttons only
  ['zh','en'].forEach(l => {
    const optBtn = document.getElementById('lopt-' + l);
    if (optBtn) optBtn.classList.toggle('active', l === lang);
  });

  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });

  // Update nav tabs
  document.getElementById('nav-practice').textContent = t('nav_practice');
  document.getElementById('nav-reference').textContent = t('nav_reference');
  document.getElementById('nav-settings').textContent = t('nav_settings');

  // Rebuild dynamic UI with translated text
  buildCategoryBar();
  buildTenseCheckboxes();
  buildPronounCheckboxes();
  buildReference();

  // Re-render card (updates meaning display language)
  renderCard();
  renderProgressStats();
  saveSettings();
}

function init() {
  loadSettings(); // restore state + dark mode before building UI
  fetch('verbs.json')
    .then(r => r.json())
    .then(data => {
      VERBS = data;
      buildQueue();
      setLang(currentLang);
      syncSettingsUI();
      renderProgressStats();
    })
    .catch(() => {
      buildQueue();
      setLang(currentLang);
      syncSettingsUI();
      renderProgressStats();
    });
}

init();
</script>
</body>
</html>
